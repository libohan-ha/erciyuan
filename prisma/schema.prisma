// Prisma Schema for anime-gallery
// PostgreSQL 数据库

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 用户表
model User {
  id        String   @id @default(uuid())
  username  String   @unique @db.VarChar(30)
  password  String   @db.VarChar(255)
  avatarUrl String?  @map("avatar_url")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // 关联
  images Image[]
  albums Album[]

  @@map("users")
}

// 相册表
model Album {
  id           String   @id @default(uuid())
  name         String   @db.VarChar(50)
  description  String?  @db.VarChar(200)
  ownerId      String   @map("owner_id")
  coverImageId String?  @map("cover_image_id")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // 关联
  owner      User    @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  coverImage Image?  @relation("AlbumCover", fields: [coverImageId], references: [id], onDelete: SetNull)
  images     Image[] @relation("AlbumImages")

  @@unique([ownerId, name])
  @@index([ownerId, createdAt(sort: Desc)])
  @@map("albums")
}

// 图片表
model Image {
  id           String   @id @default(uuid())
  url          String
  originalName String   @map("original_name")
  title        String   @db.VarChar(100)
  description  String?  @db.VarChar(500)
  tags         String[] @default([])
  ownerId      String   @map("owner_id")
  albumId      String?  @map("album_id")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // 关联
  owner        User    @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  album        Album?  @relation("AlbumImages", fields: [albumId], references: [id], onDelete: SetNull)
  albumsAsCover Album[] @relation("AlbumCover")

  @@index([ownerId, createdAt(sort: Desc)])
  @@index([tags])
  @@map("images")
}
